version: 2

_defaults: &defaults
  working_directory: ~/repo
  docker:
  - image: circleci/python:2.7.16
  environment:
    DOCKER_TEMP_IMAGE: simonsdave/dev-env:bindle

jobs:
  build_test_and_save_artifacts:
    <<: *defaults

    steps:
      - checkout
      - run:
          name: Install Virtualenv
          command: |
            virtualenv env
            source "env/bin/activate"
            pip install --upgrade pip
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "requirements.txt" }}
            - v1-dependencies-
      - run:
          name: Install Python prerequisites
          command: pip install --requirement requirements.txt
      - save_cache:
          paths:
            - ./env
          key: v1-dependencies-{{ checksum "requirements.txt" }}

workflows:
  version: 2
  build_test_and_save_artifacts:
    jobs:
      - build_test_and_save_artifacts:
          context: dev-env
